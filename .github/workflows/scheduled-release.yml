name: Scheduled Project Release

on:
  schedule:
    # æ¯å¤© UTC 16:00ï¼ˆå°ç£æ™‚é–“ 00:00 åˆå¤œï¼‰åŸ·è¡Œ
    - cron: '0 16 * * *'
  workflow_dispatch:  # ä¹Ÿå¯ä»¥æ‰‹å‹•è§¸ç™¼æ¸¬è©¦

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check and release scheduled projects
        run: |
          # å–å¾—å°ç£æ™‚é–“çš„ä»Šå¤©æ—¥æœŸ
          TODAY=$(TZ='Asia/Taipei' date +%Y-%m-%d)
          echo "Today (Taiwan): $TODAY"

          # æª¢æŸ¥æ˜¯å¦æœ‰éœ€è¦ç™¼å¸ƒçš„é …ç›®
          SCHEDULED_COUNT=$(jq --arg today "$TODAY" '[.[] | select(.date == $today and .status == "scheduled")] | length' projects.json)
          echo "Scheduled projects for today: $SCHEDULED_COUNT"

          if [ "$SCHEDULED_COUNT" -gt 0 ]; then
            # æŠŠä»Šå¤©çš„ scheduled æ”¹æˆ done
            jq --arg today "$TODAY" '
              map(if .date == $today and .status == "scheduled"
                  then .status = "done"
                  else . end)
            ' projects.json > tmp.json && mv tmp.json projects.json

            echo "Updated projects.json for $TODAY"
            cat projects.json | jq --arg today "$TODAY" '.[] | select(.date == $today)'
          else
            echo "No scheduled projects for today"
          fi

      - name: Commit and push if changed
        run: |
          git config user.name "Muripo Bot"
          git config user.email "action@github.com"

          if git diff --quiet projects.json; then
            echo "No changes to commit"
          else
            git add projects.json
            git commit -m "ðŸš€ Auto-release: $(TZ='Asia/Taipei' date +%Y-%m-%d) project is now live!"
            git push
            echo "Changes pushed successfully"
          fi
